<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel=stylesheet href="/css/main.css">
<title>Using the terraform libvirt provider to provision an Ubuntu 20.04 guest</title>
</head>
<header>
    <span><a href="/">home</a></span>
</header>
<body>
    <h1>Using the terraform libvirt provider to provision an Ubuntu 20.04 guest</h1>
    <h4>2020/12/28</h4>
    <h1 id="introduction">Introduction</h1>
<p>This HOWTO describes how to use the <a href="https://github.com/dmacvicar/terraform-provider-libvirt">terraform libvirt provider</a> to provision an Ubuntu 20.04 guest.</p>
<h1 id="prerequisites">Prerequisites</h1>
<ul>
<li>go &gt;= 1.13</li>
<li>terraform &gt;= 0.13</li>
<li>a system running libvirtd</li>
</ul>
<h1 id="install-terraform-provider-libvirt">Install terraform-provider-libvirt</h1>
<p>Download the source for the terraform libvirt provider and build the plugin:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">$ git clone git@github.com:dmacvicar/terraform-provider-libvirt.git
$ cd terraform-provider-libvirt
$ git checkout v0.6.3
$ make build
</code></pre></div><p>This will produce a <code>terraform-provider-libvirt</code> file which needs to be moved into a directory under <code>~/.local</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">$ mkdir -p ~/.local/share/terraform/plugins/registry.terraform.io/dmacvicar/libvirt/0.6.3/linux_amd64
$ mv terraform-provider-libvirt ~/.local/share/terraform/plugins/registry.terraform.io/dmacvicar/libvirt/0.6.3/linux_amd64/
</code></pre></div><h1 id="download-the-ubuntu-cloud-image">Download the Ubuntu cloud image</h1>
<p>Download the <a href="https://cloud-images.ubuntu.com/releases/focal/release/ubuntu-20.04-server-cloudimg-amd64-disk-kvm.img">focal-server-cloudimg-amd64-disk-kvm.img</a> image:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">$ wget https://cloud-images.ubuntu.com/releases/focal/release/ubuntu-20.04-server-cloudimg-amd64-disk-kvm.img
</code></pre></div><h1 id="create-terraform-resources">Create terraform resources</h1>
<p><em>The following terraform config can exist within a single <code>main.tf</code> file.</em></p>
<p>Create the <a href="https://www.terraform.io/docs/configuration/terraform.html">terraform</a> configuration resource block to define the minimum terraform version and required providers:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">terraform {
 required_version = &#34;&gt;= 0.13&#34;
  required_providers {
    libvirt = {
      source  = &#34;dmacvicar/libvirt&#34;
      version = &#34;0.6.3&#34;
    }
  }
}
</code></pre></div><p>Create a <a href="https://www.terraform.io/docs/configuration/providers.html">provider</a> configuration which defines how terraform will connect to libvirtd:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">provider &#34;libvirt&#34; {
  uri = &#34;qemu:///system&#34;
}
</code></pre></div><p>Setup a <code>pool</code> and <code>volume</code>, used to store the Ubuntu 20.04 cloud image:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">resource &#34;libvirt_pool&#34; &#34;ubuntu20&#34; {
  name = &#34;ubuntu20&#34;
  type = &#34;dir&#34;
  path = &#34;./terraform-provider-libvirt-pool-ubuntu&#34;
}

resource &#34;libvirt_volume&#34; &#34;ubuntu20&#34; {
  name   = &#34;ubuntu20&#34;
  pool   = libvirt_pool.ubuntu20.name
  source = &#34;./focal-server-cloudimg-amd64-disk-kvm.img&#34;
  format = &#34;qcow2&#34;
}
</code></pre></div><p>At this point, you should be able to run <code>terraform init</code> and <code>terraform apply</code> to create the pool and volume resources:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">$ terraform init
$ terraform apply
</code></pre></div><p>Using <a href="https://www.libvirt.org/manpages/virsh.html">virsh</a>, you can confirm that both resources have been created:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">$ virsh pool-info ubuntu20
Name:           ubuntu20
UUID:           558f8e2c-b9cb-46e6-9311-6468531322a8
State:          running
Persistent:     yes
Autostart:      yes
Capacity:       68.17 GiB
Allocation:     45.58 GiB
Available:      22.59 GiB
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">$ virsh vol-info --pool ubuntu20 ubuntu20
Name:           ubuntu20
Type:           file
Capacity:       2.20 GiB
Allocation:     528.44 MiB
</code></pre></div><p>Create a <code>user_data.cfg</code> file, adding a user to allow you to login:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">#cloud-config
ssh_pwauth: True
users:
  - name: user1
    groups: sudo
    sudo: [&#39;ALL=(ALL) NOPASSWD:ALL&#39;]
    plain_text_passwd: passw0rd
    lock_passwd: false
</code></pre></div><p>Create a <code>network_config.cfg</code> file which will be used by the guest for network configuration:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">version: 2
ethernets:
  ens3:
    dhcp4: true
</code></pre></div><p>Create a <code>meta_data.cfg</code> file which will be used to pass in data to cloudinit:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">local-hostname: ubuntu20.local
</code></pre></div><p>Using terraforms <a href="https://www.terraform.io/docs/configuration/functions/templatefile.html">templatefile</a> function to render the <code>user_data.cfg</code>, <code>network_config.cfg</code> and <code>meta_data.cfg</code> files, create a libvirt_cloudinit_disk:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">resource &#34;libvirt_cloudinit_disk&#34; &#34;commoninit&#34; {
  name           = &#34;commoninit.iso&#34;
  user_data      = templatefile(&#34;${path.module}/user_data.cfg&#34;, {})
  network_config = templatefile(&#34;${path.module}/network_config.cfg&#34;, {})
  meta_data      = templatefile(&#34;${path.module}/meta_data.cfg&#34;, {})
  pool           = libvirt_pool.ubuntu20.name
}
</code></pre></div><p>See the <a href="#how-libvirt_cloudinit_disk-works">How libvirt_cloudinit_disk works</a> if you&rsquo;re curious on how the libvirt_cloudinit_disk works with cloudinit.</p>
<p>Create a network, the guest domain using the <code>libvirt_domain</code> resource and an <code>output</code> resource that provides us with the guests IP address:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">resource &#34;libvirt_network&#34; &#34;lab&#34; {
  name      = &#34;lab&#34;
  domain    = &#34;lab.local&#34;
  mode      = &#34;nat&#34;
  addresses = [&#34;10.0.100.0/24&#34;]
}

resource &#34;libvirt_domain&#34; &#34;ubuntu20&#34; {
  name   = &#34;ubuntu20&#34;
  memory = &#34;512&#34;
  vcpu   = 1

  cloudinit = libvirt_cloudinit_disk.commoninit.id

  network_interface {
    network_name   = &#34;lab&#34;
    wait_for_lease = true
  }

  console {
    type        = &#34;pty&#34;
    target_port = &#34;0&#34;
    target_type = &#34;serial&#34;
  }

  console {
    type        = &#34;pty&#34;
    target_type = &#34;virtio&#34;
    target_port = &#34;1&#34;
  }

  disk {
    volume_id = libvirt_volume.ubuntu20.id
  }

  graphics {
    type        = &#34;spice&#34;
    listen_type = &#34;address&#34;
    autoport    = true
  }
}

output &#34;ip&#34; {
  value = libvirt_domain.ubuntu20.network_interface[0].addresses[0]
}
</code></pre></div><p>Initialize the terraform config and apply:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">$ terraform init
$ terraform apply
</code></pre></div><p>Grab the IP address from the output of <code>terraform apply</code> or <code>terraform refresh</code> and SSH using the account created within <code>user_data.cfg</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">$ ssh user1@10.0.100.66
</code></pre></div><h1 id="using-make-to-call-terraform">Using make to call terraform</h1>
<p>You can use <a href="https://www.gnu.org/software/make/">make</a> to help re-create the terraform resources with a single command.</p>
<p>Consider this <code>Makefile</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">#!/usr/bin/env make

all: terraform-destroy terraform-apply

terraform-apply: terraform-init
	terraform apply -auto-approve

terraform-destroy: terraform-init
	terraform destroy -auto-approve

terraform-init:
	terraform init

.PHONY: all terraform-apply terraform-destroy terraform-init
</code></pre></div><p>Running the single command <code>make</code> will now destroy and re-create the terraform resources.</p>
<h1 id="how-libvirt_cloudinit_disk-works">How libvirt_cloudinit_disk works</h1>
<p>The <code>libvirt_cloudinit_disk</code> resource creates an <a href="https://en.wikipedia.org/wiki/ISO_9660">ISO 9660</a> file using <code>mkisofs</code> and uploads the file to the <code>ubuntu20</code> <code>pool</code> as a <code>volume</code>.</p>
<p><code>mkisofs</code> doesn&rsquo;t ship with Debian 10, so if you&rsquo;re host system is running Debian 10, you will have to provide an alternative:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">$ sudo apt install xorriso 
$ sudo update-alternatives --install /usr/bin/mkisofs mkisofs /usr/bin/xorrisofs 10
</code></pre></div><p>The ISO 9660 file is mounted as a <em>cdrom</em> device within the guest domain:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">$ virsh dumpxml ubuntu20
[...]
    &lt;disk type=&#39;file&#39; device=&#39;cdrom&#39;&gt;
      &lt;driver name=&#39;qemu&#39; type=&#39;raw&#39;/&gt;
      &lt;source file=&#39;./terraform-provider-libvirt-pool-ubuntu/commoninit.iso&#39;/&gt;
      &lt;backingStore/&gt;
      &lt;target dev=&#39;hdd&#39; bus=&#39;ide&#39;/&gt;
      &lt;readonly/&gt;
      &lt;alias name=&#39;ide0-1-1&#39;/&gt;
      &lt;address type=&#39;drive&#39; controller=&#39;0&#39; bus=&#39;1&#39; target=&#39;0&#39; unit=&#39;1&#39;/&gt;
    &lt;/disk&gt;
[...]
</code></pre></div><p>cloudinit allows users to provide user, network and meta data files to the instance using a <a href="https://cloudinit.readthedocs.io/en/latest/topics/datasources/nocloud.html">NoCloud</a> data source which can be an ISO 9660 filesystem which has the volume label <code>cidata</code> or <code>CIDATA</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">$ blkid /dev/sr0
/dev/sr0: UUID=&#34;2021-01-03-01-59-49-00&#34; LABEL=&#34;cidata&#34; TYPE=&#34;iso9660&#34;
</code></pre></div><p>This device can be mounted, showing that it contains the <code>user_data.cfg</code>, <code>network_data.cfg</code> and <code>meta_data.cfg</code> files that were rendered by <a href="https://www.terraform.io/docs/configuration/functions/templatefile.html">templatefile</a>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">$ sudo mount /dev/sr0 /media
$ ls -la /media/*
-rwxr-xr-x 1 user1 user1  31 Jan  3 01:59 /media/meta-data
-rwxr-xr-x 1 user1 user1  46 Jan  3 01:59 /media/network-config
-rwxr-xr-x 1 user1 user1 163 Jan  3 01:59 /media/user-data
</code></pre></div>
<footer>
<a href="mailto:rene@compounddata.com">contact</a>
</footer>
</body>
</html>
